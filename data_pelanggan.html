<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Pelanggan & Upload JSON</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="data_pelanggan.css" type="text/css" media="all" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <h2>Data Pelanggan</h2>
  <table id="tabelPelanggan" class="display">
    <thead>
      <tr>
        <th>No</th>
        <th>Nama</th>
        <th>Paket</th>
        <th>Keterangan</th>
        <th>Harga</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="total">
    Total Harga: <span id="totalHarga">Rp 0</span>
  </div>

  <div class="upload-box">
    <h2>Upload Data JSON Pelanggan</h2>
    <input type="file" id="jsonFile" accept=".json" />
    <button onclick="uploadData()">Upload JSON</button>
  </div>

  <script>
    // Firebase Config (Ganti dengan milikmu)
    const firebaseConfig = {
      apiKey: "AIzaSyBXnXCSXhy06eqWBPzYmzxCo_LBzl51DO4",
      authDomain: "wibawamulianetwork.firebaseapp.com",
      databaseURL: "https://wibawamulianetwork-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "wibawamulianetwork",
      storageBucket: "wibawamulianetwork.firebasestorage.app",
      messagingSenderId: "605020393823",
      appId: "1:605020393823:web:6ba8afe7e250bc004da6ea",
      measurementId: "G-9EWJE8F5FG"
};

// Inisialisasi Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database(); // Realtime Database
    
// Fungsi Upload JSON ke Realtime Database
function uploadData() {
  console.log("Fungsi uploadData dipanggil");
  const fileInput = document.getElementById("jsonFile");
  const file = fileInput.files[0];

  if (!file) {
    alert("Pilih file JSON dulu!");
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const jsonData = JSON.parse(e.target.result);
      if (!Array.isArray(jsonData)) {
        alert("Format JSON harus array");
        return;
      }

      let uploadPromises = [];
      jsonData.forEach((pelanggan, index) => {
        const newRef = db.ref("pelanggan").push();
        uploadPromises.push(newRef.set(pelanggan));
      });

      Promise.all(uploadPromises)
        .then(() => {
          alert("Data berhasil di-upload ke Realtime Database!");
          document.getElementById("uploadBox").style.display = "none";
          document.getElementById("showUpload").style.display = "block";
          location.reload();
        })
        .catch(err => {
          alert("Gagal upload: " + err.message);
          console.error(err);
        });
    } catch (err) {
      alert("Format file JSON salah: " + err.message);
      console.error(err);
    }
  };

  reader.onerror = (err) => {
    alert("Gagal membaca file: " + err.message);
    console.error(err);
  };

  reader.readAsText(file);
}

// Ambil Data dari Realtime Database dan Tampilkan ke Tabel
let totalHarga = 0;
let no = 1;
let dataPelanggan = [];

db.ref("pelanggan").once("value").then((snapshot) => {
  console.log("Data pelanggan diambil dari Realtime Database");
  snapshot.forEach((childSnapshot) => {
    const data = childSnapshot.val();
    dataPelanggan.push(`
      <tr>
        <td>${no++}</td>
        <td>${data.nama || ''}</td>
        <td>${data.paket || ''}</td>
        <td>${data.keterangan || ''}</td>
        <td>Rp ${data.harga || '0'}</td>
      </tr>
    `);
    totalHarga += parseInt(data.harga) || 0;
  });

  document.querySelector("#tabelPelanggan tbody").innerHTML = dataPelanggan.join('');
  document.getElementById("totalHarga").innerText = `Rp ${totalHarga.toLocaleString()}`;

  $('#tabelPelanggan').DataTable({
    pageLength: 25,
    lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "Semua"] ]
  });
});

// Sembunyikan / Tampilkan Upload Box
document.getElementById("hideUpload").addEventListener("click", () => {
  document.getElementById("uploadBox").style.display = "none";
  document.getElementById("showUpload").style.display = "block";
});

document.getElementById("showUpload").addEventListener("click", () => {
  document.getElementById("uploadBox").style.display = "block";
  document.getElementById("showUpload").style.display = "none";
});
  </script>
</body>
</html>
