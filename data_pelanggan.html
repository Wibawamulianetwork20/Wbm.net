<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Pelanggan</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="data_pelanggan.css" type="text/css" media="all" />
</head>
<body>
  <h2>Data Pelanggan</h2>

  <input type="file" id="jsonFile" accept=".json" />
  <button class="btn btn-upload" onclick="uploadData()" id="uploadBtn">Upload JSON</button>
  <button class="btn btn-hapus-duplikat" onclick="hapusDuplikat()">Hapus Data Duplikat</button>

  <table id="tabelPelanggan" class="display">
    <thead>
      <tr>
        <th>No</th>
        <th>Nama</th>
        <th>Paket</th>
        <th>Keterangan</th>
        <th>Harga</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div>
    Total Harga: <span id="totalHarga">Rp 0</span>
  </div>

  <!-- Firebase + Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBXnXCSXhy06eqWBPzYmzxCo_LBzl51DO4",
      authDomain: "wibawamulianetwork.firebaseapp.com",
      databaseURL: "https://wibawamulianetwork-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "wibawamulianetwork",
      storageBucket: "wibawamulianetwork.firebasestorage.app",
      messagingSenderId: "605020393823",
      appId: "1:605020393823:web:6ba8afe7e250bc004da6ea",
      measurementId: "G-9EWJE8F5FG"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const tbody = document.querySelector('#tabelPelanggan tbody');

    // Tampilkan Data
    db.ref('pelanggan').on('value', (snapshot) => {
      tbody.innerHTML = '';
      let no = 1;
      snapshot.forEach((child) => {
        const data = child.val();
        const id = child.key;
        const tr = document.createElement('tr');
        tr.innerHTML = `
  <td>${no++}</td>
  <td>${data.nama}</td>
  <td>${data.paket}</td>
  <td>${data.keterangan}</td>
  <td>${data.harga}</td>
  <td>
    <button class="bayar" onclick="bayarPelanggan('${id}')">üí∏</button>
    <button class="edit" onclick="editPelanggan('${id}')">üìù</button>
    <button class="hapus" onclick="hapusPelanggan('${id}')">üóëÔ∏è</button>
  </td>
`;
        tbody.appendChild(tr);
      });
    });

    // Bayar (pindah ke pelangganlunas + faktur)
    function bayarPelanggan(id) {
      db.ref('pelanggan/' + id).once('value')
        .then(snapshot => {
          const data = snapshot.val();
          if (!data) {
            alert("Data tidak ditemukan!");
            return;
          }
          db.ref('pelangganlunas/' + id).set(data)
            .then(() => db.ref('pelanggan/' + id).remove())
            .then(() => {
              alert("Data dipindahkan ke pelangganlunas!");
              buatFaktur(data, id);
            });
        });
    }

    function buatFaktur(data, id) {
  const fakturWindow = window.open('', 'Faktur', 'width=800,height=1000');
  fakturWindow.document.write(`
    <html>
    <head>
      <title>Faktur Pembayaran</title>
      <style>
        @page { size: A4; margin: 20mm; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f7f7f7; padding: 0; margin: 0; }
        .faktur-container { max-width: 800px; margin: 40px auto; background: #fff; padding: 40px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        .faktur-header { text-align: center; margin-bottom: 20px; }
        .faktur-header h1 { margin: 0; color: #2c3e50; }
        .faktur-header p { margin: 5px 0; font-size: 14px; color: #555; }
        .faktur-info p { margin: 5px 0; font-size: 15px; }
        .faktur-table table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .faktur-table th, .faktur-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .faktur-table th { background: #3498db; color: white; }
        .lunas { text-align: center; color: green; font-weight: bold; margin-top: 20px; font-size: 18px; }
        .faktur-footer { text-align: center; margin-top: 40px; font-size: 14px; color: #666; }
        .btn-download { display: inline-block; background: #3498db; color: white; padding: 10px 20px; margin-top: 20px; text-decoration: none; border-radius: 5px; }
        .btn-download:hover { background: #2980b9; }
      </style>
    </head>
    <body>
      <div class="faktur-container">
        <div class="faktur-header">
          <h1>e-Billing System</h1>
          <p>WBM.NET | PT. INDO TELEMEDIA SOLUSION</p>
          <p>Email: wbmnet2020@gmail.com | Telp: 083146260133</p>
        </div>
        <h3>Bukti Pembayaran</h3>
        <div class="faktur-info">
          <p><strong>ID Pelanggan:</strong> ${id}</p>
          <p><strong>Nama:</strong> ${data.nama}</p>
          <p><strong>Paket:</strong> ${data.paket}</p>
          <p><strong>Keterangan:</strong> ${data.keterangan}</p>
          <p><strong>Harga:</strong> Rp ${data.harga}</p>
          <p><strong>Tanggal:</strong> ${new Date().toLocaleDateString()}</p>
        </div>
        <div class="lunas">LUNAS</div>
        <div class="faktur-footer">
          <p>Terima kasih telah melakukan pembayaran tepat waktu.</p>
          <p>Faktur ini dicetak secara otomatis oleh sistem e-Billing.</p>
          <button class="btn-download" onclick="window.print()">üñ®Ô∏è Cetak Faktur</button>
        </div>
      </div>
    </body>
    </html>
  `);
  fakturWindow.document.close();
}

    // Edit
    function editPelanggan(id) {
      db.ref('pelanggan/' + id).once('value')
        .then(snapshot => {
          const data = snapshot.val();
          const namaBaru = prompt("Edit Nama:", data.nama);
          const paketBaru = prompt("Edit Paket:", data.paket);
          const keteranganBaru = prompt("Edit Keterangan:", data.keterangan);
          const hargaBaru = prompt("Edit Harga:", data.harga);
          db.ref('pelanggan/' + id).update({
            nama: namaBaru || data.nama,
            paket: paketBaru || data.paket,
            keterangan: keteranganBaru || data.keterangan,
            harga: hargaBaru || data.harga
          }).then(() => {
            alert("Data berhasil diperbarui!");
          });
        });
    }

    // Hapus
    function hapusPelanggan(id) {
      if (confirm("Yakin ingin hapus data ini?")) {
        db.ref('pelanggan/' + id).remove().then(() => {
          alert("Data berhasil dihapus!");
        });
      }
    }
  </script>
</body>
</html>
