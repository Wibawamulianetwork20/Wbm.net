<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Pelanggan</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="data_pelanggan.css" type="text/css" media="all" />
</head>
<body>
  <h2>Data Pelanggan</h2>

  <input type="file" id="jsonFile" accept=".json" />
  <button class="btn btn-upload" onclick="uploadData()" id="uploadBtn">Upload JSON</button>
  <button class="btn btn-hapus-duplikat" onclick="hapusDuplikat()">Hapus Data Duplikat</button>

  <table id="tabelPelanggan" class="display">
    <thead>
      <tr>
        <th>No</th>
        <th>Nama</th>
        <th>Paket</th>
        <th>Keterangan</th>
        <th>Harga</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div>
    Total Harga: <span id="totalHarga">Rp 0</span>
  </div>

  <!-- Firebase + Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBXnXCSXhy06eqWBPzYmzxCo_LBzl51DO4",
      authDomain: "wibawamulianetwork.firebaseapp.com",
      databaseURL: "https://wibawamulianetwork-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "wibawamulianetwork",
      storageBucket: "wibawamulianetwork.firebasestorage.app",
      messagingSenderId: "605020393823",
      appId: "1:605020393823:web:6ba8afe7e250bc004da6ea",
      measurementId: "G-9EWJE8F5FG"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let totalHarga = 0;
    let no = 1;
    let dataPelanggan = [];

    db.ref("pelanggan").once("value").then(snapshot => {
      snapshot.forEach(childSnapshot => {
        const data = childSnapshot.val();
        const id = childSnapshot.key;
        dataPelanggan.push(`
          <tr>
            <td>${no++}</td>
            <td>${data.nama || ''}</td>
            <td>${data.paket || ''}</td>
            <td>${data.keterangan || ''}</td>
            <td>Rp ${data.harga || '0'}</td>
            <td>
              <button class="aksi-btn bayar" onclick="bayarPelanggan('${id}')">Bayar</button>
              <button class="aksi-btn edit" onclick="editPelanggan('${id}')">Edit</button>
              <button class="aksi-btn hapus" onclick="hapusPelanggan('${id}')">Hapus</button>
            </td>
          </tr>
        `);
        totalHarga += parseInt(data.harga) || 0;
      });

      document.querySelector("#tabelPelanggan tbody").innerHTML = dataPelanggan.join('');
      document.getElementById("totalHarga").innerText = `Rp ${totalHarga.toLocaleString()}`;
      $('#tabelPelanggan').DataTable({
        pageLength: 25,
        lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "Semua"]]
      });
    });

    function uploadData() {
      const fileInput = document.getElementById("jsonFile");
      const file = fileInput.files[0];
      if (!file) { alert("Pilih file JSON dulu!"); return; }

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const jsonData = JSON.parse(e.target.result);
          if (!Array.isArray(jsonData)) { alert("Format JSON harus array"); return; }

          let uploadPromises = [];
          jsonData.forEach((pelanggan) => {
            const newRef = db.ref("pelanggan").push();
            uploadPromises.push(newRef.set(pelanggan));
          });

          Promise.all(uploadPromises)
            .then(() => {
              alert("Data berhasil di-upload! Upload hanya bisa sekali per halaman.");
              document.getElementById("uploadBtn").disabled = true;
              fileInput.disabled = true;
              location.reload();
            })
            .catch(err => alert("Gagal upload: " + err.message));
        } catch (err) {
          alert("Format file JSON salah: " + err.message);
        }
      };
      reader.readAsText(file);
    }

    function hapusDuplikat() {
      if (confirm("Yakin ingin hapus semua data duplikat berdasarkan nama?")) {
        db.ref('pelanggan').once('value').then(snapshot => {
          let namaMap = {};
          let hapusPromises = [];

          snapshot.forEach(child => {
            const nama = child.val().nama;
            const key = child.key;

            if (namaMap[nama]) {
              hapusPromises.push(db.ref('pelanggan/' + key).remove());
            } else {
              namaMap[nama] = true;
            }
          });

          Promise.all(hapusPromises).then(() => {
            alert("Semua data duplikat berhasil dihapus!");
            location.reload();
          }).catch(err => {
            alert("Gagal menghapus data duplikat: " + err.message);
          });
        });
      }
    }

    function bayarPelanggan(id) {
  // Ambil data dari node 'pelanggan' berdasarkan ID
  db.ref('pelanggan/' + id).once('value')
    .then(snapshot => {
      const data = snapshot.val();
      if (!data) {
        alert("Data pelanggan tidak ditemukan!");
        return;
      }

      // Salin data ke node 'pelangganlunas'
      db.ref('pelangganlunas/' + id).set(data)
        .then(() => {
          // Hapus data dari 'pelanggan'
          return db.ref('pelanggan/' + id).remove();
        })
        .then(() => {
          alert("Data berhasil dipindahkan ke pelangganlunas!");
          location.reload();
        })
        .catch(err => {
          alert("Terjadi kesalahan: " + err.message);
        });
    })
    .catch(err => {
      alert("Gagal mengambil data: " + err.message);
    });
}

    function editPelanggan(id) {
      const newNama = prompt("Masukkan nama baru:");
      const newPaket = prompt("Masukkan paket baru:");
      const newKeterangan = prompt("Masukkan keterangan baru:");
      const newHarga = prompt("Masukkan harga baru:");

      if (newNama && newPaket && newKeterangan && newHarga) {
        db.ref('pelanggan/' + id).update({
          nama: newNama,
          paket: newPaket,
          keterangan: newKeterangan,
          harga: newHarga
        }).then(() => {
          alert("Data berhasil diperbarui!");
          location.reload();
        });
      }
    }

    function hapusPelanggan(id) {
      if (confirm("Yakin ingin hapus data ini?")) {
        db.ref('pelanggan/' + id).remove().then(() => {
          alert("Data berhasil dihapus!");
          location.reload();
        });
      }
    }
  </script>
</body>
</html>
