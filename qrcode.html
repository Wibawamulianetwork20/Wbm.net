<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pembayaran Pelanggan</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
</head>
<body class="bg-light">

<div class="container py-5">
  <h3 class="text-center mb-4">Pembayaran Pelanggan</h3>

  <div class="mb-3">
    <label for="idSelect" class="form-label">Pilih ID Pelanggan</label>
    <select id="idSelect" class="form-select">
      <option value="">-- Pilih --</option>
    </select>
  </div>

  <div id="infoSection" class="d-none">
    <ul class="list-group mb-3">
      <li class="list-group-item"><strong>Nama:</strong> <span id="nama"></span></li>
      <li class="list-group-item"><strong>Paket:</strong> <span id="paket"></span></li>
      <li class="list-group-item"><strong>Harga:</strong> Rp <span id="harga"></span></li>
    </ul>

    <div class="alert alert-info">
      <strong>Transfer ke:</strong>
      <ul>
        <li>BNI: 1234567890 a.n WibawaNet</li>
        <li>DANA: 081234567890 a.n WibawaNet</li>
      </ul>
    </div>

    <div class="mb-3">
      <label for="bukti" class="form-label">Upload Bukti Transfer</label>
      <input type="file" id="bukti" class="form-control" accept="image/*,.pdf" />
    </div>

    <button class="btn btn-success" onclick="bayar()">Konfirmasi Pembayaran</button>
    <div id="fakturLink" class="mt-3 text-center"></div>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBXnXCSXhy06eqWBPzYmzxCo_LBzl51DO4",
  authDomain: "wibawamulianetwork.firebaseapp.com",
  databaseURL: "https://wibawamulianetwork-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "wibawamulianetwork",
  storageBucket: "wibawamulianetwork.firebasestorage.app",
  messagingSenderId: "605020393823",
  appId: "1:605020393823:web:6ba8afe7e250bc004da6ea",
  measurementId: "G-9EWJE8F5FG"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  const select = document.getElementById("idSelect");
  const infoSection = document.getElementById("infoSection");
  const namaEl = document.getElementById("nama");
  const paketEl = document.getElementById("paket");
  const hargaEl = document.getElementById("harga");
  const fakturLink = document.getElementById("fakturLink");

  let selectedID = "";

  // Isi dropdown dari pelanggan/
  db.ref("pelanggan").once("value").then(snapshot => {
    snapshot.forEach(child => {
      const opt = document.createElement("option");
      opt.value = child.key;
      opt.textContent = child.key;
      select.appendChild(opt);
    });
  });

  // Saat memilih pelanggan
  select.addEventListener("change", () => {
    selectedID = select.value;
    if (!selectedID) return infoSection.classList.add("d-none");

    db.ref("pelanggan/" + selectedID).once("value").then(snap => {
      const data = snap.val();
      namaEl.textContent = data.nama;
      paketEl.textContent = data.paket;
      hargaEl.textContent = Number(data.harga).toLocaleString();
      infoSection.classList.remove("d-none");
    });
  });

  function bayar() {
    const file = document.getElementById("bukti").files[0];
    if (!file) return alert("Upload bukti dulu.");

    const refAktif = db.ref("pelanggan/" + selectedID);
    const storagePath = "bukti_transfer/" + selectedID + "_" + Date.now();

    refAktif.once("value").then(snap => {
      const data = snap.val();
      const tanggal = new Date().toISOString().split("T")[0];

      return storage.ref(storagePath).put(file).then(uploadSnap =>
        uploadSnap.ref.getDownloadURL().then(url => {
          return db.ref("pelangganlunas/" + selectedID).set({
            ...data,
            tanggalBayar: tanggal,
            buktiTransfer: url
          }).then(() => refAktif.remove());
        })
      );
    }).then(() => {
      alert("Pembayaran berhasil!");
      tampilkanFaktur(selectedID);
    }).catch(err => {
      console.error(err);
      alert("Gagal proses pembayaran.");
    });
  }

  function tampilkanFaktur(id) {
    db.ref("faktur/" + id).once("value").then(snapshot => {
      const url = snapshot.val();
      if (url) {
        fakturLink.innerHTML = `
          <a href="${url}" target="_blank" class="btn btn-primary mt-2">
            Lihat Faktur Pembayaran
          </a>
        `;
      } else {
        fakturLink.innerHTML = `<div class="text-muted">Faktur belum tersedia.</div>`;
      }
    });
  }
</script>

</body>
</html>
