<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Pelanggan Lunas</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="pelanggan_lunas.css">
</head>
<body>
  <h2>Data Pelanggan Lunas</h2>

  <div class= table-container>
  <table id="pelangganlunas" class="display">
    <thead>
      <tr>
        <th>No</th>
        <th>Nama</th>
        <th>Paket</th>
        <th>Keterangan</th>
        <th>Harga</th>
        <th>metode</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  </div>
  
  <!-- Firebase & Script -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBXnXCSXhy06eqWBPzYmzxCo_LBzl51DO4",
      authDomain: "wibawamulianetwork.firebaseapp.com",
      databaseURL: "https://wibawamulianetwork-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "wibawamulianetwork",
      storageBucket: "wibawamulianetwork.appspot.com",
      messagingSenderId: "605020393823",
      appId: "1:605020393823:web:6ba8afe7e250bc004da6ea"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function loadPelangganLunas() {
      const tbody = document.querySelector('#pelangganlunas tbody');
      db.ref('pelangganlunas').once('value').then(snapshot => {
        let data = '', no = 1, total = 0;
        snapshot.forEach(child => {
          const p = child.val();
          total += parseInt(p.harga);
          data += `
            <tr>
              <td>${no++}</td>
              <td>${p.nama}</td>
              <td>${p.paket}</td>
              <td>${p.keterangan}</td>
              <td>Rp ${p.harga}</td>
              <td>${p.metode}</td>
              <td>
                <button onclick="kembalikanPelanggan('${child.key}')">Kembali</button>
                <button onclick="lihatFaktur('${child.key}')">Faktur</button>
              </td>
            </tr>`;
        });
        tbody.innerHTML = data;
      });
    }

    function kembalikanPelanggan(id) {
  db.ref("pelangganlunas/" + id).once("value").then(snapshot => {
    const data = snapshot.val();
    db.ref("pelanggan/" + id).set(data).then(() => {
      // Cari dan hapus data pemasukan yang sesuai harga dan metode
      db.ref("pemasukan").once("value").then(pSnapshot => {
        pSnapshot.forEach(child => {
          const pData = child.val();
          if (pData.harga == data.harga && pData.metode == data.metode) {
            db.ref("pemasukan/" + child.key).remove();
          }
        });
      });

      // Hapus dari pelangganlunas
      db.ref("pelangganlunas/" + id).remove();
      alert("Data dikembalikan ke pelanggan aktif dan total harga diperbarui.");
      location.reload();
    });
  });
}

    function lihatFaktur(id) {
  db.ref('pelangganlunas/' + id).once('value').then(snapshot => {
    const d = snapshot.val();
    const win = window.open('', '', 'width=800,height=1000');
    win.document.write(`
      <html>
      <head>
        <title>Faktur Pembayaran</title>
        <style>
  body {
    font-family: 'Segoe UI', sans-serif;
    color: #333;
    background: #fff;
    padding: 30px;
    line-height: 1.5;
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #3498db;
    padding-bottom: 10px;
    margin-bottom: 20px;
  }

  .header img {
    width: 80px;
    height: auto;
  }

  .header .info {
    text-align: right;
  }

  h1 {
    margin: 0;
    font-size: 24px;
    color: #3498db;
  }

  h2 {
    text-align: center;
    margin: 20px 0;
    color: #2c3e50;
  }

  p {
    margin: 4px 0;
    font-size: 16px;
  }

  .lunas {
    text-align: center;
    color: green;
    font-weight: bold;
    font-size: 20px;
    margin: 20px 0;
  }

  .paraf {
    margin-top: 50px;
    text-align: right;
  }

  .paraf p {
    font-size: 14px;
  }

  .footer {
    text-align: center;
    font-size: 12px;
    color: #888;
    margin-top: 30px;
  }

  .footer button {
    margin-top: 20px;
    padding: 8px 16px;
    background: #3498db;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    cursor: pointer;
    transition: 0.3s;
  }

  .footer button:hover {
    background: #2980b9;
  }

  .info p {
    margin: 0;
    font-size: 14px;
  }

  .logo {
    width: 70px;
  }
</style>
      </head>
      <body>
        <div class="header">
          <div>
            <h1>e-Billing System</h1>
            <p>WBM.NET | PT. INDO TELEMEDIA SOLUSION</p>
            <p>Email: wbmnet2020@gmail.com | Telp: 083146260133</p>
          </div>
          <img src="wbm1.jpg" alt="Logo">
        </div>
        <h2>Bukti Pembayaran</h2>
        <p><strong>ID Pelanggan:</strong> ${id}</p>
        <p><strong>Nama:</strong> ${d.nama}</p>
        <p><strong>Paket:</strong> ${d.paket}</p>
        <p><strong>Keterangan:</strong> ${d.keterangan}</p>
        <p><strong>Harga:</strong> Rp ${parseInt(d.harga).toLocaleString()}</p>
        <p><strong>Tanggal:</strong> ${new Date().toLocaleDateString()}</p>
        <div class="lunas">LUNAS</div>
        <div class="paraf">Paraf: ______________________</div>
        <p style="text-align:right; font-weight:bold;">Admin e-Billing</p>
        <div class="footer">
          <p>Terima kasih telah melakukan pembayaran tepat waktu.</p>
          <p>Faktur ini dicetak otomatis oleh sistem e-Billing.</p>
          <button onclick="this.style.display='none'; window.print();">Cetak Faktur</button>
        </div>
      </body>
      </html>
    `);
    win.document.close();
  });
}

    document.addEventListener('DOMContentLoaded', loadPelangganLunas);
  </script>
</body>
</html>
