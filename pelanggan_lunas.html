<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Pelanggan Lunas</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="pelanggan_lunas.css">
</head>
<body>
  <h2>Data Pelanggan Lunas</h2>

  <div class= table-container>
  <table id="pelangganlunas" class="display">
    <thead>
      <tr>
        <th>No</th>
        <th>Nama</th>
        <th>Paket</th>
        <th>Keterangan</th>
        <th>Harga</th>
        <th>metode</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  </div>
  
  <!-- Firebase & Script -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBXnXCSXhy06eqWBPzYmzxCo_LBzl51DO4",
      authDomain: "wibawamulianetwork.firebaseapp.com",
      databaseURL: "https://wibawamulianetwork-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "wibawamulianetwork",
      storageBucket: "wibawamulianetwork.appspot.com",
      messagingSenderId: "605020393823",
      appId: "1:605020393823:web:6ba8afe7e250bc004da6ea"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function loadPelangganLunas() {
      const tbody = document.querySelector('#pelangganlunas tbody');
      db.ref('pelangganlunas').once('value').then(snapshot => {
        let data = '', no = 1, total = 0;
        snapshot.forEach(child => {
          const p = child.val();
          total += parseInt(p.harga);
          data += `
            <tr>
              <td>${no++}</td>
              <td>${p.nama}</td>
              <td>${p.paket}</td>
              <td>${p.keterangan}</td>
              <td>Rp ${p.harga}</td>
              <td>${p.metode}</td>
              <td>
                <button onclick="kembalikanPelanggan('${child.key}')">Kembali</button>
                <button onclick="lihatFaktur('${child.key}')">Faktur</button>
              </td>
            </tr>`;
        });
        tbody.innerHTML = data;
      });
    }

    function kembalikanPelanggan(id) {
  db.ref("pelangganlunas/" + id).once("value").then(snapshot => {
    const data = snapshot.val();
    db.ref("pelanggan/" + id).set(data).then(() => {
      // Cari dan hapus data pemasukan yang sesuai harga dan metode
      db.ref("pemasukan").once("value").then(pSnapshot => {
        pSnapshot.forEach(child => {
          const pData = child.val();
          if (pData.harga == data.harga && pData.metode == data.metode) {
            db.ref("pemasukan/" + child.key).remove();
          }
        });
      });

      // Hapus dari pelangganlunas
      db.ref("pelangganlunas/" + id).remove();
      alert("Data dikembalikan ke pelanggan aktif dan total harga diperbarui.");
      location.reload();
    });
  });
}

function lihatFaktur(id) {
  db.ref('pelangganlunas/' + id).once('value').then(snapshot => {
    const d = snapshot.val();
    const win = window.open('', '', 'width=900,height=1200');
    win.document.write(`
      <html><head><title>Faktur Pembayaran</title>
      <style>
        @page { size: A4; margin: 20mm; }
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        .header img { width: 100px; }
        .header h1 { font-size: 24px; margin: 0; }
        .header p { margin: 2px 0; }
        h2 { text-align: center; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
        .lunas { color: green; text-align: center; font-weight: bold; margin-top: 20px; font-size: 18px; }
        .footer { text-align: center; margin-top: 40px; font-size: 12px; color: #777; }
        .footer button { margin-top: 10px; background: #4CAF50; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }
        .paraf { text-align: right; margin-top: 40px; }
        .paraf p { margin: 0; }
      </style>
      </head><body>
        <div class="header">
          <div>
            <h1>e-Billing System</h1>
            <p>WBM.NET | PT. INDO TELEMEDIA SOLUSION</p>
            <p>Email: wbmnet2020@gmail.com | Telp: 083146260133</p>
          </div>
          <div>
            <img src="wbm1.jpg" alt="WBM Logo">
            <img src="indotel.jpg" alt="Indotel Logo" style="margin-left:10px;">
          </div>
        </div>

        <h2>BUKTI PEMBAYARAN</h2>
        <p><strong>ID Pelanggan:</strong> ${id}</p>
        <p><strong>Nama:</strong> ${d.nama}</p>
        <p><strong>Alamat:</strong> ${d.alamat || '-'}</p>
        <p><strong>No HP:</strong> ${d.telepon || '-'}</p>
        <p><strong>Paket:</strong> ${d.paket}</p>
        <p><strong>Keterangan:</strong> ${d.keterangan}</p>
        <p><strong>Harga:</strong> Rp ${parseInt(d.harga).toLocaleString()}</p>
        <p><strong>Metode Pembayaran:</strong> ${d.metode || '-'}</p>
        <p><strong>Tanggal:</strong> ${new Date().toLocaleDateString()}</p>

        <div class="lunas">LUNAS</div>

        <table>
          <thead>
            <tr>
              <th>No</th>
              <th>Item</th>
              <th>Harga</th>
              <th>Qty</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>1</td>
              <td>${d.paket}</td>
              <td>Rp ${parseInt(d.harga).toLocaleString()}</td>
              <td>1</td>
              <td>Rp ${parseInt(d.harga).toLocaleString()}</td>
            </tr>
          </tbody>
        </table>

        <p><strong>Terbilang:</strong> ${terbilang(parseInt(d.harga))} Rupiah</p>

        <div class="paraf">
          <p>Paraf: __________________________</p>
          <p><strong>Admin e-Billing</strong></p>
        </div>

        <div class="footer">
          <p>Terima kasih telah melakukan pembayaran tepat waktu.</p>
          <p>Faktur ini dicetak otomatis oleh sistem e-Billing.</p>
          <button onclick="this.style.display='none'; window.print();">Cetak Faktur</button>
        </div>

        <script>
          function terbilang(angka) {
            const satuan = ["", "Satu", "Dua", "Tiga", "Empat", "Lima", "Enam", "Tujuh", "Delapan", "Sembilan"];
            const belasan = ["Sepuluh", "Sebelas", "Dua Belas", "Tiga Belas", "Empat Belas", "Lima Belas", "Enam Belas", "Tujuh Belas", "Delapan Belas", "Sembilan Belas"];
            const ribuan = ["", "Ribu", "Juta", "Miliar"];
            let str = "";
            let i = 0;
            while (angka > 0) {
              let sisa = angka % 1000;
              let ratusan = Math.floor(sisa / 100);
              let puluhan = sisa % 100;
              let kata = "";
              if (ratusan > 0) kata += (ratusan == 1 ? "Seratus " : satuan[ratusan] + " Ratus ");
              if (puluhan > 0) {
                if (puluhan < 10) kata += satuan[puluhan] + " ";
                else if (puluhan < 20) kata += belasan[puluhan - 10] + " ";
                else kata += satuan[Math.floor(puluhan / 10)] + " Puluh " + satuan[puluhan % 10] + " ";
              }
              if (kata !== "") str = kata + ribuan[i] + " " + str;
              angka = Math.floor(angka / 1000);
              i++;
            }
            return str.trim() || "Nol";
          }
        </script>

      </body></html>
    `);
    win.document.close();
  });
}

    document.addEventListener('DOMContentLoaded', loadPelangganLunas);
  </script>
</body>
</html>
